<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <title>Orbital Simulation Software N</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #000;
            overflow: hidden;
            color: #fff;
        }

        /* --- Canvas --- */
        canvas.emscripten {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0 none;
            background-color: #000;
            display: block;
            outline: none;
        }

        /* --- Top Overlay (Status & Spinner) --- */
        #overlay-top {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            display: flex;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px 15px;
            border-radius: 20px;
            pointer-events: none;
            transition: opacity 0.5s;
        }
        #info-text {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 10;
            display: flex;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px 15px;
            border-radius: 20px;
            pointer-events: auto;
            transition: opacity 0.5s;
        }

        #info-text a {
            color: #bdd72e;
            text-decoration: none;
            font-size: 14px;
        }

        #info-text a:hover {
            text-decoration: underline;
        }

        .spinner {
            height: 18px;
            width: 18px;
            margin-right: 10px;
            display: inline-block;
            animation: rotation 0.8s linear infinite;
            border-left: 3px solid rgba(255, 255, 255, 0.2);
            border-right: 3px solid rgba(255, 255, 255, 0.2);
            border-bottom: 3px solid rgba(255, 255, 255, 0.2);
            border-top: 3px solid #bdd72e;
            border-radius: 100%;
        }

        @keyframes rotation {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        #status {
            font-size: 14px;
            font-weight: bold;
            color: #ccc;
        }

        /* --- Bottom Trigger Handle --- */
        #json-trigger {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            background-color: #222;
            color: #888;
            padding: 5px 20px;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 18px;
            border: 1px solid #444;
            border-bottom: none;
            transition: color 0.2s, background-color 0.2s;
        }

        #json-trigger:hover {
            background-color: #333;
            color: #fff;
        }

        /* --- JSON Editor Modal --- */
        #json-modal {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 30;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .editor-container {
            width: 80%;
            max-width: 600px;
            background: #1e1e1e;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .editor-header {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        #json-input {
            width: 100%;
            height: 300px;
            background-color: #111;
            color: #0f0;
            border: 1px solid #333;
            font-family: 'Courier New', monospace;
            padding: 10px;
            box-sizing: border-box;
            resize: vertical;
            outline: none;
        }

        .editor-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-save { background-color: #bdd72e; color: #000; }
        .btn-save:hover { background-color: #aacc22; }

        .btn-cancel { background-color: #444; color: #fff; }
        .btn-cancel:hover { background-color: #555; }

    </style>
    <script src="coi-serviceworker.js"></script>
</head>
<body>

<!-- Top Status Overlay -->
<div id="overlay-top">
    <div class="spinner" id="spinner"></div>
    <div id="status">Downloading...</div>
</div>
<div id="info-text">
    <a id="info" href="https://github.com/toastyy-1/Orbital-Sim-N">Click here for instructions</a>
</div>

<!-- The Canvas -->
<canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" tabindex="-1"></canvas>

<!-- Bottom Handle -->
<div id="json-trigger" onclick="openJsonEditor()" title="Edit Simulation Data">{ }</div>

<!-- JSON Editor Modal -->
<div id="json-modal">
    <div class="editor-container">
        <div class="editor-header">
            <span>Editing: /simulation_data.json</span>
            <span id="fs-status" style="color: #666; font-size: 12px;">Waiting for FS...</span>
        </div>
        <textarea id="json-input" spellcheck="false"></textarea>
        <div class="editor-buttons">
            <button class="btn btn-cancel" onclick="closeJsonEditor()">Cancel</button>
            <button class="btn btn-save" onclick="saveJsonData()">Save & Apply</button>
        </div>
    </div>
</div>

<script>
    var statusElement = document.getElementById("status");
    var spinnerElement = document.getElementById("spinner");
    var overlayTop = document.getElementById("overlay-top");
    var fsStatusElement = document.getElementById("fs-status");
    var isRuntimeInitialized = false;

    // --- JSON Editor Logic ---
    const FILE_PATH = '/simulation_data.json';
    const modal = document.getElementById('json-modal');
    const textarea = document.getElementById('json-input');
    const info_text = document.getElementById('info');

    // --- FIX: Stop SDL from stealing keyboard input ---
    // Emscripten/SDL often captures keyboard events on the window/document.
    // We must stop propagation on the textarea so the events don't bubble up to SDL.
    ['keydown', 'keyup', 'keypress'].forEach(eventType => {
        textarea.addEventListener(eventType, (e) => {
            e.stopPropagation();
        });
    });
    ['mousedown'].forEach(eventType => {
        info_text.addEventListener(eventType, (e) => {
            e.stopPropagation();
        });
    });

    // Helper: Reads file from FS and puts it in the textarea
    function loadDataFromFS() {
        if (!Module.FS) {
            console.warn("FS not available yet.");
            return;
        }

        try {
            // Attempt to read file
            const content = Module.FS.readFile(FILE_PATH, { encoding: 'utf8' });

            // Try to format JSON prettily
            try {
                const parsed = JSON.parse(content);
                textarea.value = JSON.stringify(parsed, null, 4);
            } catch (e) {
                textarea.value = content;
            }

            fsStatusElement.innerText = "Loaded from FS";
            fsStatusElement.style.color = "#4f4";
            console.log("Loaded data from " + FILE_PATH);

        } catch (e) {
            console.log("File not found in FS, using default template.");
            fsStatusElement.innerText = "File not found!";
            fsStatusElement.style.color = "#f84";
        }
    }

    var Module = {
        print: (function () {
            return function (text) {
                console.log(text);
            };
        })(),
        printErr: function (text) {
            console.error(text);
        },
        canvas: (function () {
            var canvas = document.getElementById("canvas");
            canvas.addEventListener("webglcontextlost", function (e) {
                alert("WebGL context lost. You will need to reload the page.");
                e.preventDefault();
            }, false);
            return canvas;
        })(),

        // Triggered when Emscripten is fully ready
        onRuntimeInitialized: function() {
            isRuntimeInitialized = true;
            console.log("Emscripten Runtime Initialized.");

            // Immediately try to load the file so it is ready for the user
            // We use a small timeout to ensure FS is mounted if using async mounts
            setTimeout(loadDataFromFS, 100);
        },

        setStatus: function (text) {
            if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
            if (text === Module.setStatus.last.text) return;

            var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
            var now = Date.now();
            if (m && now - Module.setStatus.last.time < 30) return;

            Module.setStatus.last.time = now;
            Module.setStatus.last.text = text;

            if (m) {
                text = m[1];
                spinnerElement.hidden = false;
                overlayTop.style.opacity = "1";
            } else {
                if (!text) {
                    spinnerElement.style.display = "none";
                    setTimeout(() => {
                        if(statusElement.innerHTML === "") overlayTop.style.opacity = "0";
                    }, 3000);
                }
            }
            statusElement.innerHTML = text;
        },
        totalDependencies: 0,
        monitorRunDependencies: function (left) {
            this.totalDependencies = Math.max(this.totalDependencies, left);
            Module.setStatus(left ? "Preparing... (" + (this.totalDependencies - left) + "/" + this.totalDependencies + ")" : "All downloads complete.");
        }
    };

    Module.setStatus("Downloading...");

    window.onerror = function (event) {
        Module.setStatus("Exception thrown, see JavaScript console");
        spinnerElement.style.display = "none";
        Module.setStatus = function (text) {
            if (text) console.error("[post-exception status] " + text);
        };
    };

    // --- UI Functions ---

    function openJsonEditor() {
        if (!isRuntimeInitialized) {
            alert("Simulation is still loading. Please wait.");
            return;
        }

        if (!Module.FS) {
            alert("Error: FS module not exported. Compile with -s EXPORTED_RUNTIME_METHODS=['FS']");
            return;
        }

        // Refresh data from FS just in case C++ changed it since init
        loadDataFromFS();
        modal.style.display = 'flex';

        // Focus the textarea so user can type immediately
        textarea.focus();
    }

    function closeJsonEditor() {
        modal.style.display = 'none';

        // Return focus to canvas so game controls work again immediately
        document.getElementById("canvas").focus();
    }

    function saveJsonData() {
        const rawInput = textarea.value;

        try {
            JSON.parse(rawInput); // Validate JSON
        } catch (e) {
            alert("Invalid JSON! Please fix errors before saving.\n" + e.message);
            return;
        }

        try {
            Module.FS.writeFile(FILE_PATH, rawInput);
            console.log(`Saved to ${FILE_PATH}`);
            fsStatusElement.innerText = "Saved to Memory";
            fsStatusElement.style.color = "#4f4";

            closeJsonEditor();
        } catch (e) {
            alert("Error saving file to MEMFS: " + e.message);
        }
    }

</script>

<script async src="OrbitSimulation.js"></script>
</body>
</html>
